apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: tag-release-images
  namespace: tekton-pipelines
  labels:
    app.kubernetes.io/part-of: tekton-job-standardization
spec:
  description: >
    After a merge build completes, tags the newly built images with
    the release semver version and pushes to the container registry.
    Uses crane (go-containerregistry) to copy/tag without re-building.
  params:
    - name: built-images
      type: string
      description: "JSON map of app → full image URI (with build tag)"
    - name: release-versions
      type: string
      description: "JSON map of app → release version (e.g. 0.1.0)"
    - name: image-registry
      type: string
      description: "Container registry base URL"
  results:
    - name: released-images
      description: "JSON map of app → versioned image URI"
  steps:
    - name: tag-images
      image: gcr.io/go-containerregistry/crane:debug
      script: |
        #!/busybox/sh
        set -e

        BUILT='$(params.built-images)'
        VERSIONS='$(params.release-versions)'
        REGISTRY="$(params.image-registry)"

        # Parse JSON keys/values with busybox-compatible sed/grep (no jq in crane:debug)
        parse_json_keys() { echo "$1" | sed 's/[{}"]//g' | tr ',' '\n' | sed 's/:.*//' | tr -d ' ' | grep -v '^$'; }
        parse_json_val()  { echo "$1" | sed 's/.*"'"$2"'":"//' | sed 's/".*//' ; }

        echo '{}' > /tmp/released.json

        for APP in $(parse_json_keys "$VERSIONS"); do
          VER=$(parse_json_val "$VERSIONS" "$APP")
          SRC_IMAGE=$(parse_json_val "$BUILT" "$APP")
          DST_IMAGE="${REGISTRY}/${APP}:v${VER}"

          echo "========================================="
          echo "  Tagging: $APP"
          echo "  Source:  $SRC_IMAGE"
          echo "  Dest:    $DST_IMAGE"
          echo "========================================="

          if [ -n "$SRC_IMAGE" ] && [ "$SRC_IMAGE" != "null" ]; then
            crane copy "$SRC_IMAGE" "$DST_IMAGE" 2>/dev/null || {
              echo "  WARN: crane copy failed (registry may not be reachable)"
              echo "  The image would be tagged as: $DST_IMAGE"
            }
            echo "  Tagged: $DST_IMAGE"
          else
            echo "  SKIP: No built image for $APP"
          fi

          # Build released JSON incrementally with sed
          CURRENT=$(cat /tmp/released.json)
          if [ "$CURRENT" = "{}" ]; then
            echo "{\"${APP}\":\"${DST_IMAGE}\"}" > /tmp/released.json
          else
            echo "$CURRENT" | sed "s/}$/,\"${APP}\":\"${DST_IMAGE}\"}/" > /tmp/released.json
          fi
        done

        echo ""
        echo "Released images:"
        cat /tmp/released.json
        echo ""
        cat /tmp/released.json > $(results.released-images.path)
